@startuml CreateModule
title Create Module Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "AddModule" as Controller
participant "ModuleService" as Service
participant "ModuleDAO" as DAO
participant "CourseService" as CourseService
participant "InstructorProfileDAO" as InstructorDAO

== Submit Create Module Form ==
Instructor -> Frontend: Fill form and submit\n(courseId, moduleName, moduleDescription)
activate Frontend
Frontend -> Controller: POST /addModule
activate Controller

alt Not logged in or not Instructor
    Controller -> Frontend: Redirect to login.jsp
    Frontend -> Instructor: Show login page
    deactivate Controller
    deactivate Frontend
    stop
end

Controller -> Controller: Validate session\nGet user from session
Controller -> InstructorDAO: getByUserId(userId)
activate InstructorDAO
InstructorDAO --> Controller: InstructorProfile
deactivate InstructorDAO

alt Instructor not found
    Controller -> Frontend: Redirect to /manage
    Frontend -> Instructor: Show manage page
    deactivate Controller
    deactivate Frontend
    stop
end

Controller -> Controller: Parse form parameters\n(courseId, title, description)
Controller -> CourseService: getCourseById(courseId)
activate CourseService
CourseService --> Controller: Course
deactivate CourseService

Controller -> Controller: Create Module object\nSet course, title, description

Controller -> Service: createModule(module)
activate Service
Service -> DAO: insertModule(module)
activate DAO
DAO -> DAO: INSERT INTO Module\nCalculate order_index
DAO --> Service: boolean (success/fail)
deactivate DAO

alt Success
    Service --> Controller: true
    deactivate Service
    Controller -> Frontend: Redirect to manageModule?courseId=...
    deactivate Controller
    Frontend -> Instructor: Show module list (success)
    deactivate Frontend
else Failure
    Service --> Controller: false
    deactivate Service
    Controller -> Frontend: Error response
    deactivate Controller
    Frontend -> Instructor: Show error message
    deactivate Frontend
end

@enduml

@startuml CreateLesson
title Create Lesson Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "CreateVideoLessonServlet\nCreateReadingLesson" as Controller
participant "LessonService" as Service
participant "ModuleItemDAO" as ModuleItemDAO
participant "LessonDAO" as LessonDAO
participant "ModuleDAO" as ModuleDAO
participant "YouTubeApiClient" as YouTubeAPI

== Submit Create Lesson Form ==
alt Video Lesson
    Instructor -> Frontend: Fill form and submit\n(courseId, moduleId, title, youtubeUrl)
    activate Frontend
    Frontend -> Controller: POST /createVideoLesson
    activate Controller
    
    Controller -> Controller: Parse parameters
    Controller -> YouTubeAPI: extractVideoId(youtubeUrl)
    activate YouTubeAPI
    
    alt Invalid YouTube URL
        YouTubeAPI --> Controller: null
        deactivate YouTubeAPI
        Controller -> Frontend: Redirect with error=InvalidYouTubeURL
        Frontend -> Instructor: Show error message
        deactivate Controller
        deactivate Frontend
        stop
    end
    
    YouTubeAPI --> Controller: videoId
    Controller -> YouTubeAPI: fetchIsoDuration(videoId)
    YouTubeAPI --> Controller: isoDuration
    Controller -> Controller: Convert to durationSec
    deactivate YouTubeAPI
    
    Controller -> Controller: Create Lesson object\nSet title, contentType="video"\nSet videoUrl, durationSec
    
else Reading Lesson
    Instructor -> Frontend: Fill form and submit\n(courseId, moduleId, title, content)
    activate Frontend
    Frontend -> Controller: POST /createReadingLesson
    activate Controller
    
    Controller -> Controller: Parse parameters
    Controller -> Controller: Create Lesson object\nSet title, contentType="reading"\nSet textContent
end

Controller -> Service: addLesson(lesson, moduleId)
activate Service

alt Invalid lesson data
    Service --> Controller: false
    deactivate Service
    Controller -> Frontend: Error response
    Frontend -> Instructor: Show error message
    deactivate Controller
    deactivate Frontend
    stop
end

Service -> ModuleItemDAO: getNextOrderIndex(moduleId)
activate ModuleItemDAO
ModuleItemDAO --> Service: orderIndex
deactivate ModuleItemDAO

Service -> ModuleDAO: getModuleById(moduleId)
activate ModuleDAO
ModuleDAO --> Service: Module
deactivate ModuleDAO

Service -> Service: Create ModuleItem object\nSet module, itemType="lesson"\nSet orderIndex, required=true

Service -> ModuleItemDAO: insertModuleItem(item)
activate ModuleItemDAO
ModuleItemDAO --> Service: moduleItemId
deactivate ModuleItemDAO

alt ModuleItem insert failed
    Service --> Controller: false
    deactivate Service
    Controller -> Frontend: Error response
    Frontend -> Instructor: Show error message
    deactivate Controller
    deactivate Frontend
    stop
end

Service -> Service: Set lesson.moduleItemId = moduleItemId
Service -> LessonDAO: insertLesson(lesson)
activate LessonDAO
LessonDAO -> LessonDAO: INSERT INTO Lesson
LessonDAO --> Service: void
deactivate LessonDAO

Service --> Controller: true
deactivate Service

Controller -> Frontend: Redirect to ManageLessonServlet
deactivate Controller
Frontend -> Instructor: Show lesson list (success)
deactivate Frontend

@enduml

@startuml CreateQuiz
title Create Quiz Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "CreateQuiz" as Controller
participant "QuizService" as Service
participant "ModuleItemDAO" as ModuleItemDAO
participant "QuizDAO" as QuizDAO
participant "ModuleDAO" as ModuleDAO

== Submit Create Quiz Form ==
Instructor -> Frontend: Fill form and submit\n(courseId, moduleId, title, passing_score_pct, pickCount, time_limit)
activate Frontend
Frontend -> Controller: POST /createQuiz
activate Controller

Controller -> Controller: Parse form parameters\nParse optional values (score, pick, timeLimit)

Controller -> Service: createQuiz(moduleId, title, score, pick, timeLimit)
activate Service

Service -> ModuleDAO: getModuleById(moduleId)
activate ModuleDAO
ModuleDAO --> Service: Module
deactivate ModuleDAO

Service -> ModuleItemDAO: getNextOrderIndex(moduleId)
activate ModuleItemDAO
ModuleItemDAO --> Service: orderIndex
deactivate ModuleItemDAO

Service -> Service: Create ModuleItem object\nSet module, itemType="quiz"\nSet orderIndex\nSet required based on passingScorePct

Service -> ModuleItemDAO: insertModuleItem(item)
activate ModuleItemDAO
ModuleItemDAO --> Service: moduleItemId
deactivate ModuleItemDAO

alt ModuleItem insert failed
    Service --> Controller: -1
    deactivate Service
    Controller -> Frontend: Error response
    Frontend -> Instructor: Show error message
    deactivate Controller
    deactivate Frontend
    stop
end

Service -> Service: Create Quiz object\nSet quizId=moduleItemId\nSet title, passingScorePct, pickCount, timeLimitMin

Service -> QuizDAO: insertQuiz(quiz)
activate QuizDAO
QuizDAO -> QuizDAO: INSERT INTO Quiz
QuizDAO --> Service: boolean (success/fail)
deactivate QuizDAO

alt Success
    Service --> Controller: moduleItemId
    deactivate Service
    Controller -> Frontend: Redirect to updateQuiz?quizId=...
    deactivate Controller
    Frontend -> Instructor: Show quiz update page (success)
    deactivate Frontend
else Failure
    Service --> Controller: -1
    deactivate Service
    Controller -> Frontend: Error response
    deactivate Controller
    Frontend -> Instructor: Show error message
    deactivate Frontend
end

@enduml

@startuml CreateAssignment
title Create Assignment Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "CreateAssignment" as Controller
participant "AssignmentService" as Service
participant "ModuleItemDAO" as ModuleItemDAO
participant "AssignmentDAO" as AssignmentDAO
participant "RubricCriterionDAO" as RubricDAO
participant "ModuleDAO" as ModuleDAO

== Submit Create Assignment Form ==
Instructor -> Frontend: Fill form and submit\n(courseId, moduleId, title, content, instructions, submissionType, passingScorePct, attachments, rubric criteria)
activate Frontend
Frontend -> Controller: POST /createAssignment
activate Controller

Controller -> Controller: Parse form parameters

alt Attachment file provided
    Controller -> Controller: Save attachment file\nGenerate fileUrl
else No attachment
    Controller -> Controller: Set fileUrl = null
end

Controller -> Controller: Parse rubric criteria\n(nos, guidances, weights)

Controller -> Controller: Create Assignment object\nSet all properties

Controller -> Service: createAssignment(moduleId, assignment, nos, guidances, weights)
activate Service

Service -> ModuleDAO: getModuleById(moduleId)
activate ModuleDAO
ModuleDAO --> Service: Module
deactivate ModuleDAO

Service -> ModuleItemDAO: getNextOrderIndex(moduleId)
activate ModuleItemDAO
ModuleItemDAO --> Service: orderIndex
deactivate ModuleItemDAO

Service -> Service: Create ModuleItem object\nSet module, itemType="assignment"\nSet orderIndex, required=true

Service -> ModuleItemDAO: insertModuleItem(item)
activate ModuleItemDAO
ModuleItemDAO --> Service: moduleItemId
deactivate ModuleItemDAO

Service -> ModuleItemDAO: getModuleItemById(moduleItemId)
activate ModuleItemDAO
ModuleItemDAO --> Service: ModuleItem
deactivate ModuleItemDAO

Service -> Service: Set assignment.assignmentId = ModuleItem

Service -> AssignmentDAO: insertAssignment(assignment)
activate AssignmentDAO
AssignmentDAO -> AssignmentDAO: INSERT INTO Assignment
AssignmentDAO --> Service: boolean (success/fail)
deactivate AssignmentDAO

alt Assignment insert failed
    Service --> Controller: -1
    deactivate Service
    Controller -> Frontend: Redirect with error=CreateFailed
    Frontend -> Instructor: Show error message
    deactivate Controller
    deactivate Frontend
    stop
end

alt Rubric criteria provided
    Service -> Service: Create RubricCriterion list\nFrom nos, guidances, weights
    Service -> RubricDAO: insertRubricList(criteriaList)
    activate RubricDAO
    RubricDAO -> RubricDAO: INSERT INTO RubricCriterion
    RubricDAO --> Service: void
    deactivate RubricDAO
end

Service --> Controller: moduleItemId
deactivate Service

Controller -> Frontend: Redirect to updateAssignment?assignmentId=...
deactivate Controller
Frontend -> Instructor: Show assignment update page (success)
deactivate Frontend

@enduml

@startuml CreateQuestion
title Create Question Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "AddQuestion" as Controller
participant "QuestionService" as Service
participant "QuestionDAO" as DAO
participant "InstructorProfileDAO" as InstructorDAO

== Submit Create Question Form ==
Instructor -> Frontend: Fill form and submit\n(courseId, moduleId, lessonId?, questionText, type, explanation, file?, options/answer)
activate Frontend
Frontend -> Controller: POST /addQuestion
activate Controller

alt Not logged in or not Instructor
    Controller -> Frontend: Redirect to login.jsp
    Frontend -> Instructor: Show login page
    deactivate Controller
    deactivate Frontend
    stop
end

Controller -> Controller: Parse form parameters\nLoop through multiple questions
Controller -> Controller: Handle file upload if provided\nSave to /uploads/questions

Controller -> InstructorDAO: getByUserId(userId)
activate InstructorDAO
InstructorDAO --> Controller: InstructorProfile
deactivate InstructorDAO

Controller -> Controller: Create Question object\nSet lessonId, content, type, explanation\nSet mediaUrl, status (submitted/draft)\nSet createdBy

alt Question type is MCQ Single
    Controller -> Controller: Parse options (1-4)\nParse correct answer(s)
    Controller -> Controller: Create QuestionOption list
    
    Controller -> Service: addQuestionWithOptions(question, options)
    activate Service
    Service -> DAO: insertQuestion(question)
    activate DAO
    DAO -> DAO: INSERT INTO Question\nOUTPUT INSERTED.question_id
    DAO --> Service: questionId
    deactivate DAO
    
    loop For each option
        Service -> Service: Set option.questionId = questionId
        Service -> DAO: insertOption(option)
        activate DAO
        DAO -> DAO: INSERT INTO QuestionOption
        DAO --> Service: void
        deactivate DAO
    end
    
    Service --> Controller: true
    deactivate Service

else Question type is Text
    Controller -> Controller: Parse correctAnswer text
    
    alt Correct answer provided
        Controller -> Controller: Create QuestionTextKey object\nSet answerText
        Controller -> Service: addQuestionWithTextKey(question, textKey)
    else No correct answer
        Controller -> Service: addQuestionWithTextKey(question, null)
    end
    
    activate Service
    Service -> DAO: insertQuestion(question)
    activate DAO
    DAO -> DAO: INSERT INTO Question\nOUTPUT INSERTED.question_id
    DAO --> Service: questionId
    deactivate DAO
    
    alt TextKey provided
        Service -> Service: Set textKey.questionId = questionId
        Service -> DAO: insertTextAnswer(textKey)
        activate DAO
        DAO -> DAO: INSERT INTO QuestionTextKey
        DAO --> Service: void
        deactivate DAO
    end
    
    Service --> Controller: true
    deactivate Service
end

alt LessonId provided
    Controller -> Frontend: Redirect to updateLesson?lessonId=...
else No LessonId
    Controller -> Frontend: Redirect to questions?tab=questions
end
deactivate Controller
Frontend -> Instructor: Show appropriate page (success)
deactivate Frontend

@enduml

@startuml CreateDiscussion
title Create Discussion Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "CreateDiscussion" as Controller
participant "DiscussionService" as Service
participant "DiscussionDAO" as DAO

== Submit Create Discussion Form ==
Instructor -> Frontend: Fill form and submit\n(courseId, moduleId, title, description)
activate Frontend
Frontend -> Controller: POST /createDiscussion
activate Controller

Controller -> Controller: Parse form parameters

Controller -> Service: createDiscussion(moduleId, title, description)
activate Service
Service -> DAO: insertDiscussion(moduleId, title, description)
activate DAO

DAO -> DAO: Begin transaction\nsetAutoCommit(false)

DAO -> DAO: getNextOrderIndex(moduleId)
DAO -> DAO: INSERT INTO ModuleItem\n(item_type='discussion', order_index)\nRETURN_GENERATED_KEYS

DAO -> DAO: Get moduleItemId from generated keys

DAO -> DAO: INSERT INTO Discussion\n(discussion_id=moduleItemId, title, description)

alt Transaction success
    DAO -> DAO: Commit transaction
    DAO --> Service: true
    deactivate DAO
    Service --> Controller: true
    deactivate Service
    Controller -> Frontend: Redirect to createDiscussion?courseId=...&moduleId=...
    deactivate Controller
    Frontend -> Instructor: Show discussion list (success)
    deactivate Frontend
else Transaction failed
    DAO -> DAO: Rollback transaction
    DAO --> Service: false
    deactivate DAO
    Service --> Controller: false
    deactivate Service
    Controller -> Frontend: Error response
    deactivate Controller
    Frontend -> Instructor: Show error message
    deactivate Frontend
end

@enduml

@startuml SubmitCourse
title Submit Course Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "SubmitCourse" as Controller
participant "CourseService" as Service
participant "CourseDAO" as DAO

== Request Submit Course ==
Instructor -> Frontend: Click submit button\n(courseId)
activate Frontend
Frontend -> Controller: GET /submitCourse?courseId=...
activate Controller

alt CourseId missing
    Controller -> Frontend: Redirect to /manage
    Frontend -> Instructor: Show course list
    deactivate Controller
    deactivate Frontend
    stop
end

Controller -> Controller: Parse courseId parameter

Controller -> Service: submitCourse(courseId)
activate Service
Service -> DAO: updateCourseStatus(courseId, "submitted")
activate DAO
DAO -> DAO: UPDATE Course SET status='submitted', publish_at=NULL\nWHERE course_id=?
DAO --> Service: boolean (success/fail)
deactivate DAO

alt Success
    Service --> Controller: true
    deactivate Service
    Controller -> Frontend: Redirect to /manage
    deactivate Controller
    Frontend -> Instructor: Show course list (status updated to submitted)
    deactivate Frontend
else Failure
    Service --> Controller: false
    deactivate Service
    Controller -> Frontend: Error response
    deactivate Controller
    Frontend -> Instructor: Show error message
    deactivate Frontend
end

@enduml

@startuml GetRejectionReason
title Get Rejection Reason Sequence Diagram

actor Instructor
participant "Frontend" as Frontend
participant "GetRejectionReason" as Controller
participant "CourseManagerService" as ManagerService
participant "CourseManagerDAO" as ManagerDAO
participant "CourseService" as CourseService
participant "CategoryService" as CategoryService

== Request Rejection Reason ==
Instructor -> Frontend: Click view rejection reason\n(courseId)
activate Frontend
Frontend -> Controller: GET /getRejectionReason?courseId=...
activate Controller

alt CourseId missing
    Controller -> Frontend: Redirect to manage?error=missing_id
    Frontend -> Instructor: Show course list with error
    deactivate Controller
    deactivate Frontend
    stop
end

Controller -> Controller: Parse courseId parameter

Controller -> ManagerService: getRejectionReason(courseId)
activate ManagerService
ManagerService -> ManagerDAO: getRejectReasonByCourseId(courseId)
activate ManagerDAO
ManagerDAO -> ManagerDAO: SELECT reject_reason FROM CourseManagers\nWHERE course_id=?
ManagerDAO --> ManagerService: String (rejection reason or null)
deactivate ManagerDAO
ManagerService --> Controller: String (rejection reason)
deactivate ManagerService

Controller -> Controller: Get user from session\nExtract instructorId

Controller -> CategoryService: getAllCategories()
activate CategoryService
CategoryService --> Controller: List<Category>
deactivate CategoryService

Controller -> CourseService: searchAndFilterCourses(instructorId, keyword, status)
activate CourseService
CourseService --> Controller: List<Course>
deactivate CourseService

Controller -> Frontend: Forward to teacher/courses.jsp\nSet attributes:\n- courseList\n- cateList\n- keyword, status\n- rejectedCourseId\n- rejectionReason
deactivate Controller
Frontend -> Instructor: Display course list\nHighlight rejected course\nShow rejection reason
deactivate Frontend

@enduml

